<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>编写扩展 - Simditor</title>
	<meta name="viewport" content="width=device-width">

	<link media="all" rel="stylesheet" type="text/css" href="../assets/styles/app.css" />
	<link media="all" rel="stylesheet" type="text/css" href="../assets/styles/font-awesome.css" />
	<link media="all" rel="stylesheet" type="text/css" href="../assets/styles/simditor.css" />

	<script type="text/javascript" src="../assets/scripts/jquery-2.1.0.min.js"></script>
</head>
<body>

<div class="wrapper">
	
<header>
	<h1><a href="../.">Simditor</a></h1>
	<p class="desc">简单快速的富文本编辑器</p>
</header>
<nav>
	<a href="../.">Demo</a>
	<a href="../tours/tour-usage.html" class="active">教程</a>
	<a href="../docs/doc-config.html">文档</a>
	<a href="../download.html">下载</a>
</nav>

	<section class="page-tour page-sidebar" id="page-tour-plugin">
	<aside>
	<ul>
		<li>
			<i class="icon fa fa-caret-right"></i>
			<a href="../tours/tour-usage.html">使用方法</a>
		</li>
		<li>
			<i class="icon fa fa-caret-right"></i>
			<a href="../tours/tour-dev-env.html">搭建环境</a>
		</li>
		<li class="active">
			<i class="icon fa fa-caret-right"></i>
			<a href="../tours/tour-plugin.html">编写扩展</a>
		</li>
		<li>
			<i class="icon fa fa-caret-right"></i>
			<a href="../tours/tour-button.html">编写按钮</a>
		</li>
	</ul>
</aside>


	<article class="editor-style">
		<p>这篇教程主要介绍如何为 Simditor 编写一个自动保存扩展，这个扩展需要实现这些功能：</p>

<ul>
<li>在编辑器的内容发生变化的时候，编辑器的内容会被自动保存到 localStorage；</li>
<li>编辑器初始化的时候，如果发现 localStorage 里保存了上一次编辑的内容，扩展会将编辑器的默认值设置为上一次编辑的内容；</li>
<li>编辑器所在表单提交的时候，localStorage 里保存的内容会被重置</li>
</ul>

<h3>扩展的基本结构</h3>

<p>创建 <code>simditor-autosave.coffee</code>，输入扩展的基本结构：</p>
<div class="highlight"><pre><code class="coffee language-coffee" data-lang="coffee"><span class="k">class</span> <span class="nx">SimditorAutosave</span> <span class="k">extends</span> <span class="nx">Plugin</span>
  <span class="nv">constructor: </span><span class="nf">(@widget) -&gt;</span>
    <span class="k">super</span> <span class="nx">@widget</span>
    <span class="vi">@editor = </span><span class="nx">@widget</span>

  <span class="nv">_init: </span><span class="nf">-&gt;</span>

<span class="nx">Simditor</span><span class="p">.</span><span class="nx">connect</span> <span class="nx">SimditorAutosave</span>
</code></pre></div>
<p>Simditor 的扩展继承自 <a href="https://github.com/mycolorway/simple-module">Simple Module</a> 的 <a href="https://github.com/mycolorway/simple-module/blob/master/src/module.coffee#L66">Plugin类</a>，并且 Simditor 提供一个类方法 <code>connect</code> 用来安装扩展。</p>

<p>在初始化扩展的时候，Simditor 会给 Plugin 的 constructor 方法传入自己的引用 <code>@widget</code>。</p>

<p><code>_init</code> 方法和 <code>constructor</code> 的区别是，constructor 在 Simditor 初始化扩展的时候（Simditor 自身初始化之前）调用，而 <code>_init</code> 方法会在 Simditor 自身初始化完成之后调用。所以，在 <code>_init</code> 方法中，@widget 的这些属性才是可用的：</p>

<ul>
<li><code>@widget.textarea</code>：与 Simditor 绑定的 textarea 元素；</li>
<li><code>@widtet.el</code>：Simditor 的容器元素 <code>div.simditor</code>；</li>
<li><code>@widget.body</code>：Simditor的内容元素 <code>div.simditor-body[contenteditable=true]</code>。</li>
</ul>

<h3>扩展的初始化选项</h3>

<p>我们需要给 Simditor 增加一个 autosave 选项，用来开关 autosave 功能并且构造 localStorage 的 key：</p>
<div class="highlight"><pre><code class="coffee language-coffee" data-lang="coffee"><span class="k">class</span> <span class="nx">SimditorAutosave</span> <span class="k">extends</span> <span class="nx">Plugin</span>
  <span class="nv">opts:</span>
    <span class="nv">autosave: </span><span class="kc">false</span>

  <span class="nv">constructor: </span><span class="nf">(@widget) -&gt;</span>
    <span class="k">super</span> <span class="nx">@widget</span>
    <span class="vi">@editor = </span><span class="nx">@widget</span>

  <span class="nv">_init: </span><span class="nf">-&gt;</span>
    <span class="vi">@opts.autosave = </span><span class="nx">@opts</span><span class="p">.</span><span class="nx">autosave</span> <span class="o">||</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">textarea</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;autosave&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="nx">@opts</span><span class="p">.</span><span class="nx">autosave</span>
    <span class="nv">key = </span><span class="s">&#39;simditor-autosave-&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">@opts</span><span class="p">.</span><span class="nx">autosave</span> <span class="o">||</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>

<span class="nx">Simditor</span><span class="p">.</span><span class="nx">connect</span> <span class="nx">SimditorAutosave</span>
</code></pre></div>
<p>Plugin 的 opts 属性会与 Simditor 的 opts 保持同步，所以我们可以在 <code>_init</code> 方法里通过 <code>@opts.autosave</code> 来获取 Simditor 初始化时传入的 autosave 选项。</p>

<h3>添加核心逻辑</h3>

<p>准备工作都做好之后，我们就可以添加扩展的核心逻辑了：</p>
<div class="highlight"><pre><code class="coffee language-coffee" data-lang="coffee"><span class="k">class</span> <span class="nx">SimditorAutosave</span> <span class="k">extends</span> <span class="nx">Plugin</span>
  <span class="nv">opts:</span>
    <span class="nv">autosave: </span><span class="kc">false</span>

  <span class="nv">constructor: </span><span class="nf">(@widget) -&gt;</span>
    <span class="k">super</span> <span class="nx">@widget</span>
    <span class="vi">@editor = </span><span class="nx">@widget</span>

  <span class="nv">_init: </span><span class="nf">-&gt;</span>
    <span class="vi">@opts.autosave = </span><span class="nx">@opts</span><span class="p">.</span><span class="nx">autosave</span> <span class="o">||</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">textarea</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;autosave&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">unless</span> <span class="nx">@opts</span><span class="p">.</span><span class="nx">autosave</span>
    <span class="nv">key = </span><span class="s">&#39;simditor-autosave-&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="nx">@opts</span><span class="p">.</span><span class="nx">autosave</span> <span class="o">||</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>

    <span class="nx">@editor</span><span class="p">.</span><span class="nx">on</span> <span class="s">&quot;valuechanged&quot;</span><span class="p">,</span> <span class="o">=&gt;</span>
      <span class="nx">localStorage</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">@editor</span><span class="p">.</span><span class="nx">getValue</span><span class="p">()</span>

    <span class="nx">@editor</span><span class="p">.</span><span class="nx">el</span><span class="p">.</span><span class="nx">closest</span><span class="p">(</span><span class="s">&#39;form&#39;</span><span class="p">).</span><span class="nx">on</span> <span class="s">&#39;submit&#39;</span><span class="p">,</span> <span class="nf">(e) -&gt;</span>
      <span class="nx">localStorage</span><span class="p">.</span><span class="nx">removeItem</span> <span class="nx">key</span>

    <span class="nx">@editor</span><span class="p">.</span><span class="nx">setValue</span><span class="p">(</span><span class="nx">localStorage</span><span class="p">[</span><span class="nx">key</span><span class="p">])</span> <span class="k">if</span> <span class="nx">localStorage</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>

<span class="nx">Simditor</span><span class="p">.</span><span class="nx">connect</span> <span class="nx">SimditorAutosave</span>
</code></pre></div>
<p>其中，<code>valuechanged</code> 是 Simditor 的自定义事件，每当编辑器的内容发生变化时会被触发，更多关于该事件的信息请参考<a href="../docs/doc-event.html">事件文档</a>。</p>

	</article>
</section>






	
<footer>
	&copy; <a href="http://tower.im">彩程设计</a>
</footer>

</div>

</body>
</html>

